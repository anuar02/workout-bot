const { google } = require('googleapis');

class SheetsService {
    constructor() {
        this.auth = new google.auth.GoogleAuth({
            keyFile: 'google-credentials.json',
            scopes: [
                'https://www.googleapis.com/auth/spreadsheets',
                'https://www.googleapis.com/auth/drive.file'  // ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
            ],
        });

        this.sheets = google.sheets({ version: 'v4', auth: this.auth });
        this.drive = google.drive({ version: 'v3', auth: this.auth });
    }

    // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É —á–µ—Ä–µ–∑ Drive API
    async createUserSheet(username, telegramId) {
        try {
            console.log(`üìÑ –°–æ–∑–¥–∞—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è ${username}...`);

            // 1. –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ Drive API
            const fileMetadata = {
                name: `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ${username}`,
                mimeType: 'application/vnd.google-apps.spreadsheet'
            };

            const driveFile = await this.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });

            const spreadsheetId = driveFile.data.id;
            console.log(`‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω: ${spreadsheetId}`);

            // 2. –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —á–µ—Ä–µ–∑ Sheets API
            await this.sheets.spreadsheets.values.update({
                spreadsheetId: spreadsheetId,
                range: 'Sheet1!A1:F1',
                valueInputOption: 'RAW',
                resource: {
                    values: [['–î–∞—Ç–∞', '–í—Ä–µ–º—è', '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', '–ü–æ–¥—Ö–æ–¥—ã', '–í–µ—Å (–∫–≥)', '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è']]
                }
            });

            // 3. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç)
            await this.sheets.spreadsheets.batchUpdate({
                spreadsheetId: spreadsheetId,
                resource: {
                    requests: [{
                        repeatCell: {
                            range: {
                                sheetId: 0,
                                startRowIndex: 0,
                                endRowIndex: 1
                            },
                            cell: {
                                userEnteredFormat: {
                                    textFormat: {
                                        bold: true
                                    }
                                }
                            },
                            fields: 'userEnteredFormat.textFormat.bold'
                        }
                    }]
                }
            });

            console.log(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞: https://docs.google.com/spreadsheets/d/${spreadsheetId}`);
            return spreadsheetId;

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:', error.message);

            // –î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –æ—à–∏–±–∫–∏
            if (error.code === 403) {
                console.error('\n‚ö†Ô∏è  –û–®–ò–ë–ö–ê –î–û–°–¢–£–ü–ê:');
                console.error('1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤–∫–ª—é—á–µ–Ω Google Drive API');
                console.error('2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ Service Account –∏–º–µ–µ—Ç —Ä–æ–ª—å Editor');
                console.error('3. –ü–æ–¥–æ–∂–¥–∏ 1-2 –º–∏–Ω—É—Ç—ã –ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è API\n');
            }

            throw error;
        }
    }

    // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É
    async appendWorkout(sheetId, workout) {
        try {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ru-RU');
            const timeStr = now.toLocaleTimeString('ru-RU');

            await this.sheets.spreadsheets.values.append({
                spreadsheetId: sheetId,
                range: 'Sheet1!A:F',
                valueInputOption: 'RAW',
                resource: {
                    values: [[
                        dateStr,
                        timeStr,
                        workout.exercise || 'N/A',
                        workout.sets || 'N/A',
                        workout.weight || 'N/A',
                        workout.reps || 'N/A'
                    ]]
                }
            });

            console.log(`‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—É ${sheetId}`);

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É:', error.message);
            throw error;
        }
    }

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏
    async getAllWorkouts(sheetId) {
        try {
            const response = await this.sheets.spreadsheets.values.get({
                spreadsheetId: sheetId,
                range: 'Sheet1!A2:F'
            });

            return response.data.values || [];

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:', error.message);
            return [];
        }
    }

    // –°–¥–µ–ª–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    async shareWithUser(sheetId, userEmail) {
        try {
            await this.drive.permissions.create({
                fileId: sheetId,
                requestBody: {
                    type: 'user',
                    role: 'writer',
                    emailAddress: userEmail
                },
                sendNotificationEmail: false
            });

            console.log(`‚úÖ –î–æ—Å—Ç—É–ø –≤—ã–¥–∞–Ω: ${userEmail}`);

        } catch (error) {
            console.error('‚ö†Ô∏è  –ù–µ —Å–º–æ–≥ –≤—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø:', error.message);
            // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
        }
    }
}

module.exports = new SheetsService();
